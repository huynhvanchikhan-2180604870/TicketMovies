<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:300,400,700&amp;display=swap" rel="stylesheet">
    <link href="https://unpkg.com/bootstrap-table@1.16.0/dist/bootstrap-table.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <title>Nhom Chot</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link  rel="stylesheet" href="/seat/css/chunk.css"/>
    <link  rel="stylesheet" href="/seat/css/main-chunk.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"/>

</head>
<body>
<div>
    <div class="container-fluid bg-light" style="padding-top: 20px;">
        <div class="bookTicket__content row mt-5">
            <div class="checkOut__left col-md-9 col-sm-12 p-0">
                <div class="bookSlot">
                    <div class="poster__film"
                         style="width: 0;
                               ">
                    </div>
                    <div class="bookSlot__content" style="overflow-x: scroll;">
                        <div class="theater__info d-flex justify-content-between">
                            <div class="theater__img d-flex bg-light"><img alt="hinhanh"
                                                                           th:src="${showtime.movie.poster_url}">
                                <div class="theater__name">
                                        	<span class="name">
                                        		<span class="subname" th:text="${showtime.theater.name}"></span>
                                        	</span>
                                    <p class="showtime" id="starttime" th:text="'Ngày chiếu: '+${showtime.startTime}"></p>
                                    <p class="showtime" id="endtime" th:text="'Giờ chiếu: '+${showtime.endTime}"></p>
                                </div>
                                <input th:value="${showtime.id}" id="showtime_id" hidden>
                            </div>
                            <div class="timeKeepSlot">
                                <p class="title__text" style="font-size: 14px;">Đếm ngược kết thúc lịch chiếu</p><span
                                    class="time" style="font-size: 22px;"></span>
                            </div>
                        </div>
                        <div class="chooseSlot" style="width: 850px">
                            <div class="screen__img"><img src="https://i.ibb.co/zWgWjtg/screen.png" alt="screen">
                            </div>
                            <div class="picking row" style="padding: 0 50px;">
                                <div class="slot__picking col-12">
                                    <div class="slot__row">
                                        <i th:each="seat: ${seats}" class="fa fa-couch slot__item"
                                           th:classappend="${seat.isActive} ?
                                                (${seat.isChecked} ? 'item--picked':
                                                (${seat.isOccupied} ? 'item--checked':
                                                (${seat.isVip} ? 'item--vip':''))):
                                                 'item--hiden'"
                                           th:data-seat="${seat.name}"
                                           th:data-price="${seat.isVip}? ${showtime.price}+10000:${showtime.price}"
                                           th:data-seat-id="${seat.id}"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="slot__detail row">
                                <div class="col-md-3 col-sm-6 col-xs-6"><i
                                        class="fa fa-couch item--picking"></i><span class="slot__text">Ghế đang
                                                chọn</span></div>
                                <div class="col-md-2 col-sm-6 col-xs-6"><i
                                        class="fa fa-couch item--picked"></i><span class="slot__text">Ghế có người
                                                </span></div>
                                <div class="col-md-2 col-sm-6 col-xs-6"><i
                                        class="fa fa-couch item--regular"></i><span class="slot__text">Ghế Thường</span>
                                </div>
                                <div class="col-md-2 col-sm-6 col-xs-6"><i class="fa fa-couch item--vip"></i><span
                                        class="slot__text">Ghế Vip</span></div>
                                <div class="col-md-3 col-sm-6 col-xs-6"><i class="fa fa-couch item--checked"></i><span
                                        class="slot__text">Ghế của bạn</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="checkOut__right col-md-3 col-sm-12">
                <div class="checkout__form">
                    <div class="total__price"><span class="price" data-price="0">0₫</span></div>
                    <div class="film__info">
                        <span class="film__age--C" th:text="${showtime.movie.category.age_accept}"></span>
                        <span class="film__name" th:text="${showtime.theater.name}"></span>
                        <p class="film__detail" th:text="${showtime.startTime}+' - '+${showtime.endTime}"></p>
                        <p class="theater__name" th:text="${showtime.theater.cinema.name}"></p>
                        <p class="film__address" th:text="${showtime.theater.cinema.location}"></p>
                    </div>
                    <div class="count__slot">
                        <div>Ghế đã chọn:</div>
                        <div class="slot"></div>
                    </div>
                    <div class="discountForm d-flex justify-content-between">
                        <div class="discountForm__content"><label class="label__name">Mã giảm giá</label><input
                                type="text" name="code" id="txtDiscountCode" class="form-control d-inline"
                                placeholder="Nhập tại đây..."></div>
                        <button id="btnCheckCode" class="btn mb-2">Áp
                            dụng
                        </button>
                    </div>

                    <div class="payForm"><a class="pay__link" href="/#"><span class="title__text">Hình thức thanh
                                        toán</span>
                        <p class="text__notification">Vui lòng chọn ghế để hiển thị phương thức thanh toán phù
                            hợp.</p>
                    </a></div>


                </div>
                <div class="textNotification text-center"><i class="fa fa-info-circle text-danger mr-1"></i><span
                        class="noti__text">Vé đã mua không thể đổi hoặc hoàn tiền Mã vé sẽ được gửi qua tin nhắn
                                <span class="noti__link">ZMS</span> (tin nhắn Zalo) và <span
                            class="noti__link">Email</span>
                                đã nhập. </span></div>
                <button id="btn-booking" class="btnBook" data-toggle="modal" data-target="#CreditModal" onclick="createBill('VNPAY')">Thanh toán</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
<script src="/seat/js/fnmain.js"></script>
<script>
    function remainingTime() {
        const today = new Date();
        const dateSchedule = new Date(`[[${showtime.startTime}]] [[${showtime.endTime}]]`);
        console.log("date: ", dateSchedule);

        const seconds = Math.floor((dateSchedule - today) / 1000);
        if (seconds > 0) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds - h * 3600 - m * 60;
            return `${h} giờ ${m} phút ${s} giây `;
        }
        return null;
    };
    function loadUser(callback, username) {
        console.log("username: ",username)
        $.ajax({
            type: "GET",
            url: "/api/users/get-by-username/" + username,
            success: function (user) {
                console.log("User info:", user);
                callback(null, user);
            },
            error: function (error) {
                console.log("Error loading user info:", error);
                callback(error, null);
            }
        });
    };

    function getCurrentUsername(callback) {
        $.ajax({
            type: "GET",
            url: "/api/users/get-current-username",
            success: function (username) {
                console.log("Current username:", username);
                callback(null, username);
            },
            error: function (error) {
                console.log("Error getting current username:", error);
                callback(error, null);
            }
        });
    }

    $("#btn-booking-cod").click(function () {
        createBill("COD");
    });

    $("#btn-booking-vnpay").click(function () {
        createBill("VNPAY");
    });

    function createBill() {
        if (dataParameter.length != 0) {
            getCurrentUsername(function (error, currentUsername) {
                if (error) {
                    $("#text-error").html("Có lỗi xảy ra khi lấy username hiện tại.");
                    $("#error").addClass("swal-overlay--show-modal");
                    return;
                }

                console.log("Calling loadUser with username:", currentUsername);
                let currentPrice = Number(price.data("price"));
                console.log("Current price:", currentPrice);
                loadUser(function (error, user) {
                    if (error) {
                        $("#text-error").html("Có lỗi xảy ra khi tải thông tin người dùng.");
                        $("#error").addClass("swal-overlay--show-modal");
                        return;
                    }
                    console.log(user);
                    var username = user.username;
                    var password = user.password; // Mật khẩu giả định được lấy từ phản hồi API
                    var authHeader = "Basic " + btoa(username + ":" + password);

                    var showtime_id = $('#showtime_id').val();
                    console.log("Showtime id: ", showtime_id);

                    var json = JSON.stringify({
                        "user_id": user.id,
                        "showtime_id": showtime_id,
                        "list_seat_id": dataParameter,
                        "paymentMethod": "VNPAY",
                        "price":currentPrice
                    });

                    console.log("Fetch data: ", json);

                    $.ajax({
                        type: "POST",
                        url: "/api/bills/create",
                        headers: {"Authorization": authHeader},
                        data: json,
                        contentType: "application/json; charset=utf-8",
                        success: function (data) {
                            // Redirect to VNPay payment URL
                            window.location.href = data.paymentUrl;
                        },
                        error: function (e) {
                            $("#text-error").html(e.responseText);
                            $("#error").addClass("swal-overlay--show-modal");
                            $("button").click(function (e) {
                                location.reload(true);
                            });
                        }
                    });
                }, currentUsername);
            });
        } else {
            $("#text-error").html("Bạn chưa chọn chỗ ngồi!");
            $("#error").addClass("swal-overlay--show-modal");
        }
    }



</script>
</body>
</html>
